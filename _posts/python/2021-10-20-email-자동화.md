---
title: email ìë™í™”
excerpt: AWS, SMTP ë¥¼ ì‚¬ìš©í•œ ë°ì´í„° ì¶”ì¶œ ë° ì´ë©”ì¼ ë°œì†¡ ìë™í™”

categories:
  - Python

tags:
  - AWS
  - email
  - SMTP

toc: true
toc_sticky: true
toc_label: Send Email
---

â¤ï¸ Python3.7, AWS lambda, S3 ì‚¬ìš© ê¸°ì¤€ìœ¼ë¡œ ì‘ì„±í•˜ì˜€ìŠµë‹ˆë‹¤.
{: .notice--danger}

# ë°°ê²½  
íšŒì‚¬ì—ì„œ ì—…ë¬´í•˜ë‹¤ë³´ë©´ íƒ€ë¶€ì„œì—ì„œ ë°˜ë³µì ì¸ ë°ì´í„° ì¶”ì¶œ ìš”ì²­ì´ ë“¤ì–´ì˜¤ê³¤ í–ˆë‹¤.  
ê·¸ëŸ´ë•Œë§ˆë‹¤ í—‰ .. íœ´ê°€ë•ŒëŠ” ì–´ë–»ê²Œ í•˜ì§€ ğŸ¤” .... ë‹¹í™©í•˜ê¸°ë„ í•˜ê³  ë§¤ì¼ ê°™ì€ ì‹œê°„ì— ê¸°ê³„ì²˜ëŸ¼ ì½”ë“œ ëŒë ¤ì„œ ë©”ì¼ì— ì²¨ë¶€ë“œë¦¬ëŠ” ê²ƒì´ ë¹„íš¨ìœ¨ì ìœ¼ë¡œ ëŠê»´ì¡Œë‹¤. ~~ì‚´ì§ ê·€ì°®ê¸°ë„~~
ë”°ë¼ì„œ, ì´ì‚¬ë‹˜ì˜ ì¡°ì–¸ìœ¼ë¡œ AWS Lambda ê·¸ë¦¬ê³  S3 ë‘ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•˜ì—¬ email ë°œì†¡ ìë™í™” ì½”ë“œë¥¼ ë§Œë“¤ê²Œ ë˜ì—ˆë‹¤.  

# ë“¤ì–´ê°€ê¸° ì „, ë°°ê²½ì§€ì‹ ğŸ¦
## SMTP  
**Simple Mail Transfer Protocol**  
ì¸í„°ë„· ë©”ì¼ì˜ ì†¡ì‹ (ë³´ë‚¼ ë•Œ)ì— ì‚¬ìš©ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ í”„ë¡œí† ì½œ  
í¬íŠ¸ëŠ” ì£¼ë¡œ 25ë²ˆì„ ì‚¬ìš©í•œë‹¤. Email ì†¡ì‹  ì‹œ ë°ì´í„°ëŠ” ì†¡ì‹ ìì˜ SMTP ì„œë²„ë¥¼ íƒ€ê³  ìˆ˜ì‹ ìì˜ SMTP ì„œë²„ë¡œ ë³´ë‚´ì§„ ë’¤ ë©”ì¼ ë°•ìŠ¤ì— ì €ì¥ ëœë‹¤.  
ë©”ì¼ë°•ìŠ¤ë€ ë©”ì¼ ì„œë²„ ì•ˆì— ìˆëŠ” ê°œì¸ìš© í´ë”ë¥¼ ë§í•˜ëŠ”ë°, ì¸í„°ë„·ì— ì„¤ì¹˜ëœ ì‚¬ì„œí•¨ê³¼ ê°™ì€ ì—­í• ì„ í•œë‹¤.  
ì¦‰, ì†¡ì‹ ë˜ì–´ ì˜¨ ë©”ì¼ì€ ë°›ëŠ” ì‚¬ëŒì˜ ì‚¬ì„œí•¨ì— ì €ì¥ë˜ëŠ”ë°, ì‹¤ì œë¡œ ê·¸ ì‚¬ìš©ìê°€ ìˆ˜ì·¨í•  ë•Œê¹Œì§€ ì €ì¥ë˜ì–´ ìˆë‹¤ëŠ” ê²ƒì´ë‹¤.  
<ê·¸ë¦¼ í•œ ì¥ìœ¼ë¡œ ë³´ëŠ” ìµœì‹  ë„¤íŠ¸ì›Œí¬ ìš©ì–´ í•´ì„¤ (ì •ë³´ë¬¸í™”ì‚¬), P.202>
{: .notice--info}

## MIME
**Multipurpose Internet Mail Extensions**  
ì¸í„°ë„· ë©”ì¼ì—ì„œëŠ” ASCII ë¬¸ìë°–ì— ë‹¤ë£° ìˆ˜ ì—†ë‹¤. ì´ê²ƒì„ í™•ì¥í•˜ì—¬ í•œêµ­ì–´ì™€ ê°™ì€ 2ë°”ì´íŠ¸ ë¬¸ì ì·¨ê¸‰ì´ë‚˜ ì „ìë©”ì¼ì— íŒŒì¼ ì²¨ë¶€ê°€ 
ê°€ëŠ¥í•˜ë„ë¡ í•˜ê¸° ìœ„í•œ ê·œê²©ì´ MIMEì´ë‹¤.  
ì „ìë©”ì¼ ë³¸ë¬¸ì„ ì—¬ëŸ¬ íŒŒíŠ¸ë¡œ ë‚˜ëˆ ì„œ íŒŒíŠ¸ë§ˆë‹¤ 'Content-Type'ê³¼ ê°™ì€ ê°ì¢… í—¤ë” ì •ë³´ë¥¼ ì¶”ê°€í•˜ì—¬ ê±°ê¸°ì— ASCII ë¬¸ìë¡œ ë³€í™˜í•œ ë°”ì´ë„ˆë¦¬ ë°ì´í„°ë¥¼ ì €ì¥.  
ë°ì´í„° -> ASCII ë¬¸ìë¡œ ë³€í™˜í•˜ëŠ” ë° ì£¼ë¡œ **Base64** ë¼ëŠ” ë°©ë²•ì´ ì“°ì¸ë‹¤. ì–´ë–¤ ì •ë³´ë¥¼ ì‚¬ìš©í–ˆëŠ”ì§€ëŠ” MIMEê°€ ë§ë¶™ì´ëŠ” í—¤ë” ì •ë³´ì— ê¸°ìˆ ë˜ì–´ ìˆìœ¼ë©°
ìˆ˜ì‹ ì¸¡ì—ì„œëŠ” ì´ í—¤ë” ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì›ë˜ì˜ íŒŒì¼ë¡œ ë³µì›í•œë‹¤.  
<ê·¸ë¦¼ í•œ ì¥ìœ¼ë¡œ ë³´ëŠ” ìµœì‹  ë„¤íŠ¸ì›Œí¬ ìš©ì–´ í•´ì„¤ (ì •ë³´ë¬¸í™”ì‚¬), P.220 ìš”ì•½>  
{: .notice--info}  

## SSL
**Secure Sockets Layer**  
Netscape Communicationsì‚¬ê°€ ê°œë°œí•œ ì•”í˜¸í™” í”„ë¡œí† ì½œ.  
ë„¤íŠ¸ì›Œí¬ì—ì„œ ì„œë¡œë¥¼ ì¸ì¦í•¨ìœ¼ë¡œì¨ 'ê°€ì¥'ì„ ë§‰ê³  í†µì‹  ë°ì´í„°ë¥¼ ì•”í˜¸í™”í•¨ìœ¼ë¡œì¨ ë°ì´í„°ì˜ 'ë„ì²­'ì´ë‚˜ 'ë³€ì¡°'ë¥¼ ë§‰ëŠ”ë‹¤.  
<ê·¸ë¦¼ í•œ ì¥ìœ¼ë¡œ ë³´ëŠ” ìµœì‹  ë„¤íŠ¸ì›Œí¬ ìš©ì–´ í•´ì„¤ (ì •ë³´ë¬¸í™”ì‚¬), P.212 ìš”ì•½>  
{: .notice--info}  

# íŒŒì´í”„ë¼ì¸
![Image]({{"/assets/images/Email.png"|relative_url}})  

# í”„ë¡œì íŠ¸ í´ë”
```bash
Project
|__init__.py
|runcode.py
|code
  |__init__.py
  |ExtractData.py
  |SendMail.py
|helper
  |__init__.py
  |delete_customer.py
  |ReadDB.py
```

# ë³¸ê²©ì ìœ¼ë¡œ, ì½”ë”© ğŸ”¥
## Import Library
- Pandas : DataFrame ë‹¤ë£¨ê¸° ìœ„í•˜ì—¬
- boto3 : S3 ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•¨
- io : [ë¬¸ì œì  > ì²«ì§¸, S3ì— Excel í˜•ì‹ìœ¼ë¡œ ì €ì¥í•˜ê¸°](#ë¬¸ì œì ) ë¥¼ ì°¸ê³  
- email : Header, Mime ì‚¬ìš© (í…ìŠ¤íŠ¸ -> byte ë³€í™˜)
- smtplib : SMTP, SSL, TLS ì‚¬ìš© (SMTP í”„ë¡œí† ì½œ ì‚¬ìš©)
- os : í™˜ê²½ë³€ìˆ˜ load (.env) <br/>

## SendMail.py ì‘ì„±  
ì´ë¯¸ DB ì—ì„œ ë¶ˆëŸ¬ì™€ ì „ì²˜ë¦¬ë¥¼ ë§ˆì¹œ Excel íŒŒì¼ì´ ìŠ¤ëƒ…ìƒ·ìœ¼ë¡œ S3ì— ì €ì¥ë˜ìˆë‹¤ê³  ê°€ì •.  
Lambdaì˜ í™˜ê²½ë³€ìˆ˜ ë¡œë“œëŠ” ì–´ë µì§€ ì•Šë‹¤. êµ¬ì„± > í™˜ê²½ë³€ìˆ˜ ì„¹ì…˜ì—ì„œ í¸ì§‘ì„ ëˆŒëŸ¬ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.  
ë¡œì»¬ì´ ì•„ë‹Œ EC2 ì¸ìŠ¤í„´ìŠ¤ì™€ ê°™ì€ í´ë¼ìš°ë“œ ì„œë²„ë¥¼ ì‚¬ìš©í•˜ì—¬ SMTP ì„œë²„ë¥¼ ì„¸íŒ…í•  ìˆ˜ ìˆë‹¤.  

### íŒŒì¼ ì²¨ë¶€í•˜ì§€ ì•Šì„ ë•Œ
```python
import smtplib
from email.mime.text import  MIMEText
from email.header import Header

# í™˜ê²½ë³€ìˆ˜
driver = os.getenv('DRIVER')
host = os.getenv('HOST')
port = os.getenv('PORT')
user = os.getenv('USER')
pwd = os.getenv('PWD')

# SMTP ì—°ê²°
s = smtplib.SMTP(
    host=host,
    port=port
)

# SSL í˜¹ì€ TLS ë³´ì•ˆ ì„¤ì • í›„ ë¡œê·¸ì¸
s.starttls()
s.login(user, pwd)

# ë‚´ìš© ì‘ì„± : MIMEì„ ì‚¬ìš©í•˜ì—¬ ASCIIë¡œ ë³€í™˜ 
msg = MIMEText(_text='{ë³¸ë¬¸ë‚´ìš©}')
msg['Subject'] = Header(s='{ì œëª©}', charset='utf-8')

from_addr='{ìˆ˜ì‹ ë©”ì¼ì£¼ì†Œ}'
to_addr='{ë°œì†¡ë©”ì¼ì£¼ì†Œ}'

# SMTPì— ë‚´ìš© ì‹¤ì–´ì„œ ë³´ë‚´ê¸° (msg ì—ëŠ” ì´ë¯¸ ASCIIë¡œ ë³€í™˜ëœ í…ìŠ¤íŠ¸ ë¬¸ìê°€ ë©”ëª¨ë¦¬ ìƒì— ìˆì„ ê²ƒ)
s.sendmail(
    from_addr,
    to_addr,
    msg.as_string()
)

s.quit()
```

### íŒŒì¼ ì²¨ë¶€í•  ë•Œ  
ì‚¬ìš© ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì‚´ì§ ë‹¬ë¼ì§„ë‹¤. ìì„¸í•œ ë‚´ìš©ì€ ì•„ë˜ì˜ [ë¬¸ì œì  > ì…‹ì§¸, íŒŒì¼ì²¨ë¶€](#ë¬¸ì œì ) ë¥¼ ì°¸ê³  
```python
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from email.mime.application import MIMEApplication
import boto3 

# í™˜ê²½ë³€ìˆ˜
driver = os.getenv('DRIVER')
host = os.getenv('HOST')
port = os.getenv('PORT')
user = os.getenv('USER')
pwd = os.getenv('PWD')

# SMTP ì—°ê²°
s = smtplib.SMTP(
    host=host,
    port=port
)

# SSL í˜¹ì€ TLS ë³´ì•ˆ ì„¤ì • í›„ ë¡œê·¸ì¸
s.starttls()
s.login(user, pwd)

# ì•„ë˜ ë¶€ë¶„ì´ ë‹¬ë¼ì§„ë‹¤.
msg = MIMEMultipart()
msg['Subject'] = 'ë©”ì¼ ì œëª©'
msg.attach(MIMEText('ë©”ì¼ ë³¸ë¬¸'))

s3 = boto3.resource('s3')
bucket = 'your_bucket'
key = 'your_key/excel.xlsx'
obj = s3.Object(bucket, key)
attachment = obj.get()['Body'].read()

part = MIMEApplication(attachment, Name='ë©”ì¼ ì²¨ë¶€íŒŒì¼ì— í‘œê¸°ë  íŒŒì¼ëª…')
msg.attach(part)
# ë‹¬ë¼ì§ <ë>

# SMTPì— ë‚´ìš© ì‹¤ì–´ì„œ ë³´ë‚´ê¸° (msg ì—ëŠ” ì´ë¯¸ ASCIIë¡œ ë³€í™˜ëœ í…ìŠ¤íŠ¸ ë¬¸ìê°€ ë©”ëª¨ë¦¬ ìƒì— ìˆì„ ê²ƒ)
s.sendmail(
    from_addr,
    to_addr,
    msg.as_string()
)

s.quit()
```

# ë¬¸ì œì 
## ì²«ì§¸, S3ì— Excel í˜•ì‹ìœ¼ë¡œ ì €ì¥í•˜ê¸°
ë©”ëª¨ë¦¬ì— ì €ì¥ëœ Pandas DataFrame ì„ ë¡œì»¬ì— íŠ¹ì •í•œ ì €ì¥ ì—†ì´ S3ì— ì €ì¥í•˜ëŠ” ë° ì–´ë ¤ì›€ì„ ê²ªì—ˆë‹¤ ..^^;  
AWS Lambdaì— ì½”ë“œ ì˜¬ë¦´ ê²ƒì´ê¸° ë•Œë¬¸ì— ì´ëŸ¬í•œ ë¬¸ì œì ì„ í•´ê²°í•´ì•¼í–ˆë‹¤!  

**ğŸ” í•´ê²°ì±… io.BytesIO() ì‚¬ìš©**  
1)io libraryë¥¼ ì‚¬ìš©í•˜ì—¬ ì¸ ë©”ëª¨ë¦¬ ë°”ì´ë„ˆ ìŠ¤íŠ¸ë¦¼ì„ Byte ê°ì²´ë¡œ ë³€í™˜ (ğŸ¤” ë” ê³µë¶€ í•„ìš”í•œ ë¶€ë¶„, ioì— ê´€í•˜ì—¬ ì˜ ëª¨ë¥´ê² ë‹¤.)  
2)pd.ExcelWriter íŒŒì¼ ê²½ë¡œ ëŒ€ì‹  io.BytesIO ì§€ì •  
3)getvalue() : io library ë¡œ ë²„í¼ì˜ ì „ì²´ ë‚´ìš©ì„ í¬í•¨í•˜ëŠ” bytesë¥¼ ë°˜í™˜  
4)DataFrame -> Excel -> output (ì„¸ì…˜ ë°”ê¹¥ì— ì—´ë ¤ ìˆìœ¼ë¯€ë¡œ)  
êµ¬ê¸€ë§í•˜ë©° ì°¾ì€ ì •ë³´ë¼ ì¡°ê¸ˆ ë” ê³µë¶€ê°€ í•„ìš”í•œ ë¶€ë¶„ì„ ! (io ëŠ” ë¬´ì—‡ì¸ì§€? ìŠ¤íŠ¸ë¦¼ ê°ì²´ë€?)
{: .notice--info}  

```python
# save in S3
import io
import boto3
import pandas as pd

bucket = {bucket_name}
with io.BytesIO as output:
    with pd.ExcelWriter(output, engine='xlsxwriter') as writer:
        {DF}.to_excel(writer)
    data = output.getvalue()
s3_resource = boto3.resource('s3')
s3_resource.Object(bucket, '{bucket_key}/file_name.xlsx').put(Body=data)
```

**Reference**  
- [íŒŒì´ì¬ ê³µì‹ í™ˆí˜ì´ì§€](https://python.flowdas.com/library/io.html)  
- [xlsxwriter ê°€ì´ë“œ](https://xlsxwriter.readthedocs.io/working_with_pandas.html#saving-the-dataframe-output-to-a-string)  
- [Stack overflow : Store Excel file exported from Pandas in AWS](https://stackoverflow.com/questions/54862629/store-excel-file-exported-from-pandas-in-aws)

## ë‘˜ì§¸, AWS Lambda Library ì¶”ê°€  
AWSì˜ Lambda ì„œë¹„ìŠ¤ëŠ” ê¸°ë³¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ë§Œ ì œê³µí•˜ê³  ìˆë‹¤. ~~boto3ì™€ ê°™ì€ ìê¸°ë„¤ ì„œë¹„ìŠ¤ ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” ê·¸ëƒ¥ ì œê³µí•˜ëŠ” ë“¯í•˜ë‹¤.~~  
ìœ„ì˜ ì½”ë“œ ê·¸ëŒ€ë¡œ ëŒë¦¬ë©´ ì´ë¯¸ ì„¸íŒ…ëœ í™˜ê²½ì— ë”°ë¼ ë‹¤ë¥¸ë° ì•„ë§ˆ pandasì™€ xlsxwriterì„ ì½ì§€ ëª»í•  ê²ƒì´ë‹¤.  

**ğŸ” í•´ê²°ì±… Layer ì¶”ê°€**  
AWS Lambdaì— Layerë¥¼ ì¶”ê°€í•œë‹¤. ì•„ë˜ ë¸”ë¡œê·¸ë¥¼ ì°¸ê³ í•´ ë ˆì´ì–´ ì¶”ê°€ë¥¼ í•˜ì˜€ë‹¤.  
[AWS Lambda Layer ì¶”ê°€](https://blog.naver.com/chandong83/221852027113)
{: .notice--info}  

## ì…‹ì§¸, íŒŒì¼ ì²¨ë¶€  
MIMEText ì„ ì–¸ í›„ bytesë¡œ ë³€í™˜ëœ excel íŒŒì¼ì„ attach í•˜ë©´ `Cannot attach additional subparts to non-multipart/*`
ì—ëŸ¬ë¥¼ ë¦¬í„´í•œë‹¤. ë‹¹ì—°í•˜ë‹¤. ë‚˜ í…ìŠ¤íŠ¸ ë¿ ì•„ë‹ˆë¼ Multipart ì“¸ê±°ì•¼ í•˜ê³  ì „ë‹¬í•´ì¤˜ì•¼í•œë‹¤. ~~ì—­ì‹œ ì‚½ì§ˆí•´ì•¼ ì–»ëŠ” ê²ƒì´ ë§ë‹¤~~  

**ğŸ” MIMEMultipart ì‚¬ìš©**  
MIMEMultipartë¥¼ ì‚¬ìš©í•œ ì¸ìŠ¤í„´ìŠ¤ì— attach ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ Excel(bytes) ì™€ Textë¥¼ ì…ë ¥í•œë‹¤.
{: .notice--info}

```python
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from email.mime.application import MIMEApplication
import boto3 

# ìƒì„¸ ì½”ë“œ ìƒëµ
msg = MIMEMultipart()
msg['Subject'] = 'ë©”ì¼ ì œëª©'
msg.attach(MIMEText('ë©”ì¼ ë³¸ë¬¸'))

# File Read
s3 = boto3.resource('s3')
bucket = 'your_bucket'
key = 'your_key/excel.xlsx'
obj = s3.Object(bucket, key)
attachment = obj.get()['Body'].read()
part = MIMEApplication(attachment, Name='ë©”ì¼ ì²¨ë¶€íŒŒì¼ì— í‘œê¸°ë  íŒŒì¼ëª…')
msg.attach(part)

# .... ì´í•˜ ìƒëµ 
```

### ìƒì„¸ ì½”ë“œ
ë‹¹ì—° ë¬¸ì œë  ë‚´ìš© ëª¨ë‘ ë§ˆìŠ¤í‚¹ í•œ ê¹ƒí—ˆë¸Œ ì½”ë“œì´ë‹¤ :)   
- [Github](https://github.com/Sol-Hee/SendMarketingMessage)